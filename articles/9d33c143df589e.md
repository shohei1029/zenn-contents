---
title: "Azure OpenAI Serviceã§Microsoft Entra ID (Azure AD)èªè¨¼ã‚’ä½¿ã£ã¦ã¿ã‚‹ (Python)"
emoji: "ğŸ˜¶â€ğŸŒ«ï¸"
type: "tech"
topics:
  - "azure"
  - "python"
  - "microsoft"
  - "openai"
  - "chatgpt"
published: true
published_at: "2023-04-05 23:58"
publication_name: "microsoft"
---

# ã¯ã˜ã‚ã«
Azure OpenAI ServiceãŒæœ¬å®¶OpenAIç¤¾ã®APIã¨ç•°ãªã‚‹éƒ¨åˆ†ã®ä¸€ã¤ã«ã€Azure OpenAIã§ã¯ã€APIã‚­ãƒ¼ã®èªè¨¼ã«åŠ ãˆã¦Microsoft Entra ID (æ—§ç§° Azure Active Directory; Azure AD)ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«å¯¾å¿œã—ã¦ã„ã‚‹ã“ã¨ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚
ãŸã ã€å¤šãã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯APIã‚­ãƒ¼ã«ã‚ˆã‚‹èªè¨¼ã§æ›¸ã‹ã‚Œã¦ã„ãŸãŸã‚ã€Microsoft Entra ID (ME-ID)èªè¨¼ã§Azure OpenAIã®APIã‚’å©ãæ–¹æ³•ã‚’ãƒ¡ãƒ¢ã—ã¾ã™ã€‚

# å‰æ
APIã‚­ãƒ¼ãƒ™ãƒ¼ã‚¹ã§Azure OpenAI ServiceãŒåˆ©ç”¨ã§ãã‚‹ç¨‹åº¦ã®ç’°å¢ƒã¯æ•´ã£ã¦ã„ã‚‹ã¨æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€Azure OpenAI Serviceã®ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒä½œæˆã§ãã€ã¾ãŸPythonç’°å¢ƒã‚„`openai`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒã§ã™ã€‚

Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼š
- `openai`
- `azure-identity`
	- ç‰¹ã«Azure SDK for Pythonã‚’æ™®æ®µä½¿ã£ã¦ã„ãªã„å ´åˆã¯ç’°å¢ƒã«å…¥ã£ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§`pip install azure-identity`ã‚’è¡Œã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

# äº‹å‰æº–å‚™
å¯¾è±¡ã¨ãªã‚‹Azure ADãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€å½“è©²Azure Azure OpenAIãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹`Cognitive Services ãƒ¦ãƒ¼ã‚¶ãƒ¼`ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

å‰²ã‚Šå½“ã¦æ–¹æ³•ãŒä¸æ˜ãªå ´åˆã¯ä¸‹è¨˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
[Azure portal ã‚’ä½¿ç”¨ã—ã¦ Azure ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ - Azure RBAC | Microsoft Learn](https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal#step-2-open-the-add-role-assignment-page)

æ¬¡å›³ã®ã‚ˆã†ã«å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ãŒã•ã‚Œã¦ã„ã‚Œã°æ­£å¸¸ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/477f245f9846-20230405.png)

# ã‚³ãƒ¼ãƒ‰

## APIã‚­ãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆ (å‚è€ƒ)
Azure Portalç­‰ã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ã¨ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚
Azure OpenAIãƒªã‚½ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã®[ã‚­ãƒ¼ã¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ]ãƒšãƒ¼ã‚¸ã‚ˆã‚Šç¢ºèªã§ãã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/b765706977bc-20230406.png)

ã‚­ãƒ¼1 (ã‚ã‚‹ã„ã¯2)ã‚’`openai.api_key`ã«ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’`openai.api_base`ã«æŒ‡å®šã—ã¾ã™ã€‚
```python
import openai

openai.api_type = "azure"
openai.api_key = "<AZURE_OPENAI_API_KEY>"
openai.api_base = "https://openai-lab.openai.azure.com/" #ãƒªã‚½ãƒ¼ã‚¹ã«ã‚ˆã£ã¦ç•°ãªã‚‹
openai.api_version = "2023-03-15-preview"
```

## Azure ADèªè¨¼ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆ

Azure ADèªè¨¼ã‚’ä½¿ã†å ´åˆã€Azure ADãƒˆãƒ¼ã‚¯ãƒ³å–å¾—éƒ¨åˆ†ã®è¿½åŠ ã¨ã€ãã‚Œã«åˆã‚ã›ã¦openaiãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼éƒ¨åˆ†ã®å¤‰æ›´ãŒå¿…è¦ã§ã™ã€‚

```python
from azure.identity import DefaultAzureCredential
import openai

# Request credential
default_credential = DefaultAzureCredential()
token = default_credential.get_token("https://cognitiveservices.azure.com/.default")

# Setup parameters
openai.api_type = "azure_ad"
openai.api_key = token.token
openai.api_base = "https://openai-lab.openai.azure.com/" #ãƒªã‚½ãƒ¼ã‚¹ã«ã‚ˆã£ã¦ç•°ãªã‚‹
openai.api_version = "2023-03-15-preview"
```

## APIã‚’ä½¿ã£ã¦ã¿ã‚‹
ä¾‹ã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®GPT-3ãƒ¢ãƒ‡ãƒ«ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ•ã’ã¾ã™ã€‚
`deployment_id`ã«Azure OpenAIã§ä½œæˆã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆåã‚’æŒ‡å®šã—ã¾ã™ã€‚

```python
# create a completion
completion = openai.Completion.create(deployment_id="text-davinci-003", prompt="Hello world, logging test")

# print the completion
print(completion.choices[0].text)
```
çµæœã€`This is a test of logging capabilities to see if a message can get`ãªã©ã¨è¡¨ç¤ºã•ã‚ŒãŸã‚‰æˆåŠŸã§ã™ã€‚
ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã€Azureã¸ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒæ­£å¸¸ã«ã§ãã¦ã„ã‚‹ã‹ã€expireã—ã¦ã„ãªã„ã‹ç­‰ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# ã•ã„ã”ã«
ç„¡äº‹ã«Azure ADã‚’åˆ©ç”¨ã—ã¦Azure OpenAIãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹èªè¨¼ã‚’è¡Œãˆã¾ã—ãŸï¼ã‚ˆã‚Š[è¤‡é›‘ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ãƒŠãƒªã‚ª](https://learn.microsoft.com/ja-jp/azure/active-directory/develop/active-directory-how-to-integrate)ã«ã‚‚å¯¾å¿œå¯èƒ½ãªãŸã‚ãœã²ã”æ´»ç”¨ãã ã•ã„ã€‚

# å‚è€ƒ
## å…¨ä½“
- [ãƒãƒãƒ¼ã‚¸ãƒ‰ ID ã‚’ä½¿ç”¨ã—ã¦ Azure OpenAI Service ã‚’æ§‹æˆã™ã‚‹æ–¹æ³• - Azure OpenAI | Microsoft Learn](https://learn.microsoft.com/ja-jp/azure/cognitive-services/openai/how-to/managed-identity)
- [openai Â· PyPI](https://pypi.org/project/openai/)
- [azure-identity Â· PyPI](https://pypi.org/project/azure-identity/)
## DefaultAzureCredential class
- [Azure ã§ãƒ›ã‚¹ãƒˆã•ã‚Œã‚‹ Java ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èªè¨¼ã™ã‚‹ | Microsoft Learn](https://learn.microsoft.com/ja-jp/azure/developer/java/sdk/identity-azure-hosted-auth)
- [azure.identity.DefaultAzureCredential class | Microsoft Learn](https://learn.microsoft.com/ja-jp/python/api/azure-identity/azure.identity.defaultazurecredential?view=azure-python)